#!/bin/bash
# The Sprawl CLI // v0.1
# "The street finds its own uses for things."

set -e

# 1. Resolve Locations
# Get the absolute path of this script, satisfying symlinks.
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Resolve the Core Templates path (Sibling directory)
CORE_DIR="$(dirname "$SCRIPT_DIR")/core"
TEMPLATE_DIR="$CORE_DIR/templates/scaffold"

echo -e "\033[0;36mðŸŒ† THE SPRAWL // SYSTEM INITIALIZATION\033[0m"

# 2. Validation
if [ ! -d "$TEMPLATE_DIR" ]; then
    echo -e "\033[0;31m[ERROR] Core Protocol Missing.\033[0m"
    echo "Expected at: $TEMPLATE_DIR"
    echo "Ensure 'packages/core' is mapped correctly."
    exit 1
fi

# 3. Scaffolding Logic
scaffold_workspace() {
    echo -e "\033[0;33m[..] Constructing Grid...\033[0m"

    mkdir -p .agent/rules .agent/workflows

    # Copy Templates
    cp "$TEMPLATE_DIR/gitignore" .gitignore
    cp "$TEMPLATE_DIR/global.md" .agent/rules/global.md
    cp "$TEMPLATE_DIR/init.md" .agent/workflows/init.md
    cp "$TEMPLATE_DIR/dashboard.md" AGENT_CONTROL_DASHBOARD.md

    # Copy Prime Directive if it exists
    if [ -f "$CORE_DIR/rules/GEMINI.md" ]; then
        cp "$CORE_DIR/rules/GEMINI.md" .agent/rules/PRIME_DIRECTIVE.md
        echo -e "\033[0;32m[OK] Prime Directive Installed.\033[0m"
    fi

    # Scaffold Standard Hub Architecture (The Visible Structure)
    echo -e "\033[0;33m[..] Stabilizing Hub Architecture...\033[0m"
    mkdir -p Rules Skills Workflows Knowledge Scripts

    # Add keepfiles to ensure git tracking
    touch Rules/.gitkeep Skills/.gitkeep Workflows/.gitkeep Knowledge/.gitkeep Scripts/.gitkeep

    echo -e "\033[0;32m[OK] Construct Ready.\033[0m"
    echo "ðŸ‘‰ Action: Open Agent Manager (Cmd+L) and type '/init'."
}

# 4. Sync Logic (The Grid Link)
sync_grid() {
    echo -e "\033[0;33m[..] Synchronizing Grid Constructs...\033[0m"

    # Define Construct Directory (Default to ~/The_Sprawl_Constructs)
    CONSTRUCT_DIR="$HOME/The_Sprawl_Constructs"
    mkdir -p "$CONSTRUCT_DIR"

    # TODO: Read from a config file. For now, we simulate the Fleet.
    # In a real scenario, this list comes from a central manifest.
    REPOS=(
        #"https://github.com/Start-Corp/finance-construct.git"
        #"https://github.com/Start-Corp/marketing-construct.git"
    )

    if [ ${#REPOS[@]} -eq 0 ]; then
        echo "No constructs defined in Fleet Manifest."
        echo "Edit 'packages/cli/sprawl' to add repositories."
        exit 0
    fi

    for repo in "${REPOS[@]}"; do
        name=$(basename "$repo" .git)
        target="$CONSTRUCT_DIR/$name"
        echo "Syncing $name..."

        if [ -d "$target" ]; then
            (cd "$target" && git pull)
        else
            git clone "$repo" "$target"
        fi
    done

    echo -e "\033[0;32m[OK] Grid Synchronization Complete.\033[0m"
}

# 5. Interface
case "$1" in
    init)
        # Pass the second argument (the name) to the function
        # e.g. sprawl init "Marketing Hub"
        scaffold_workspace "$2"
        ;;
    sync)
        sync_grid
        ;;
    *)
        echo "Usage: sprawl [init <name>|sync]"
        exit 1
        ;;
esac
