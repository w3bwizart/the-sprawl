#!/bin/bash
# The Sprawl CLI // v0.1
# "The street finds its own uses for things."

VERSION="1.0.0"

set -e

# 1. Resolve Locations
# Get the absolute path of this script, satisfying symlinks.
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Resolve the Core Templates path
# Priority 1: Relative Path (Dev Mode)
# Priority 2: Installed Path (Prod Mode)
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
RELATIVE_CORE="$(dirname "$SCRIPT_DIR")/core"
INSTALLED_CORE="$HOME/.sprawl/core"

if [ -d "$RELATIVE_CORE" ]; then
    CORE_DIR="$RELATIVE_CORE"
elif [ -d "$INSTALLED_CORE" ]; then
    CORE_DIR="$INSTALLED_CORE"
else
    echo -e "\033[0;31m[ERROR] Core Protocol Missing.\033[0m"
    echo "Checked: $RELATIVE_CORE"
    echo "Checked: $INSTALLED_CORE"
    exit 1
fi

TEMPLATE_DIR="$CORE_DIR/templates/scaffold"



# 2. Validation
# 2. Validation
if [ ! -d "$TEMPLATE_DIR" ]; then
    echo -e "\033[0;31m[ERROR] Templates invalid.\033[0m"
    echo "Path: $TEMPLATE_DIR"
    exit 1
fi

# 3. Scaffolding Logic
scaffold_workspace() {
    # 1. Determine Hub Name
    # Use first argument if provided, else use current directory name
    HUB_NAME="$1"
    if [ -z "$HUB_NAME" ]; then
        HUB_NAME=$(basename "$PWD")
    fi

    echo -e "\033[0;33m[..] Constructing Grid: $HUB_NAME ...\033[0m"

    mkdir -p .agent/rules .agent/workflows

    # Copy Templates
    cp "$TEMPLATE_DIR/gitignore" .gitignore

    # Process Templates with Hub Name
    # We use sed to replace {{HUB_NAME}} with the actual name
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/global.md" > .agent/rules/global.md
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/init.md" > .agent/workflows/init.md
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/dashboard.md" > AGENT_CONTROL_DASHBOARD.md

    # Copy Prime Directive if it exists
    if [ -f "$CORE_DIR/rules/GEMINI.md" ]; then
        cp "$CORE_DIR/rules/GEMINI.md" .agent/rules/PRIME_DIRECTIVE.md
        echo -e "\033[0;32m[OK] Prime Directive Installed.\033[0m"
    fi

    # Scaffold Standard Hub Architecture (The Visible Structure)
    echo -e "\033[0;33m[..] Stabilizing Hub Architecture...\033[0m"
    mkdir -p Rules Skills Workflows Knowledge Scripts

    # Add keepfiles to ensure git tracking
    touch Rules/.gitkeep Skills/.gitkeep Workflows/.gitkeep Knowledge/.gitkeep Scripts/.gitkeep

    # Documentation: Inject Protocol Explanations
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/README_Rules.md" > Rules/README.md
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/README_Skills.md" > Skills/README.md
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/README_Workflows.md" > Workflows/README.md
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/README_Knowledge.md" > Knowledge/README.md
    sed "s/{{HUB_NAME}}/$HUB_NAME/g" "$TEMPLATE_DIR/README_Scripts.md" > Scripts/README.md

    echo -e "\033[0;32m[OK] Construct Ready: $HUB_NAME\033[0m"

    # Check for package.md (Manifest for Dependencies)
    PACKAGE_FILE="package.md"
    if [ -f "$PACKAGE_FILE" ]; then
        echo -e "\033[0;33m[..] Processing Package Manifest...\033[0m"
        while IFS= read -r line || [[ -n "$line" ]]; do
            # Skip comments and empty lines
            [[ "$line" =~ ^#.*$ ]] && continue
            [[ -z "$line" ]] && continue

            # Parse Format: type:name (e.g., rule:finance-auditor)
            TYPE=$(echo "$line" | cut -d':' -f1 | tr '[:upper:]' '[:lower:]')
            NAME=$(echo "$line" | cut -d':' -f2 | xargs)

            SOURCE_PATH=""
            DEST_PATH=""

            case "$TYPE" in
                rule)
                    SOURCE_PATH="$CORE_DIR/Hub/Rules/$NAME.md"
                    DEST_PATH="Rules/$NAME.md"
                    ;;
                skill)
                    SOURCE_PATH="$CORE_DIR/Hub/Skills/$NAME"
                    DEST_PATH="Skills/$NAME"
                    ;;
                workflow)
                    SOURCE_PATH="$CORE_DIR/Hub/Workflows/$NAME.md"
                    DEST_PATH="Workflows/$NAME.md"
                    ;;
                *)
                    echo "Unknown type: $TYPE"
                    continue
                    ;;
            esac

            if [ -e "$SOURCE_PATH" ]; then
                echo "Installing $TYPE: $NAME"
                cp -r "$SOURCE_PATH" "$DEST_PATH"
            else
                echo -e "\033[0;31m[!] Missing $TYPE: $NAME (Not found in Core)\033[0m"
            fi
        done < "$PACKAGE_FILE"
        echo -e "\033[0;32m[OK] Packages Installed.\033[0m"
    fi

    echo "ðŸ‘‰ Action: Open Agent Manager (Cmd+L) and type '/init'."
}

# 4. Sync Logic (The Grid Link)
sync_grid() {
    echo -e "\033[0;33m[..] Synchronizing Grid Constructs...\033[0m"

    # 0. Self-Update (Update The Sprawl itself)
    # We rely on the script location to find the repo root (../../)
    REPO_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

    if [ -d "$REPO_ROOT/.git" ]; then
        echo -e "\033[0;33m[..] Checking Core Protocol Updates...\033[0m"
        # Use quiet pull to keep it clean, show output only on error
        if (cd "$REPO_ROOT" && git pull -q); then
             echo -e "\033[0;32m[OK] Core Protocol Active.\033[0m"
        fi
    fi

    # Define Construct Directory
    # We use the Corporate Standard location
    CONSTRUCT_DIR="$HOME/Documents/SprawlHubs"
    mkdir -p "$CONSTRUCT_DIR"

    # Define Manifest Path (Data separation)
    # In full Git structure, CORE_DIR is packages/core.
    # Logic in line 18 sets CORE_DIR based on script siblings.
    # If SCRIPT_DIR is packages/cli, dirname is packages. packages/core is sibling.
    # So CORE_DIR should be correct.
    MANIFEST="$CORE_DIR/grid-manifest.conf"

    if [ ! -f "$MANIFEST" ]; then
        echo -e "\033[0;31m[ERROR] Grid Manifest not found at: $MANIFEST\033[0m"
        exit 1
    fi

    # Read Repositories from Manifest (ignoring comments and empty lines)
    # mapfile is essentially 'readarray', standard in Bash 4.0+
    mapfile -t REPOS < <(grep -vE '^\s*#|^\s*$' "$MANIFEST")

    if [ ${#REPOS[@]} -eq 0 ]; then
        echo -e "\033[0;32m[OK] System Sync Complete.\033[0m"
        echo -e "\033[0;36mðŸ’¡ Tip: To sync other projects, add them to:\033[0m"
        echo "   $MANIFEST"
        exit 0
    fi

    for repo in "${REPOS[@]}"; do
        # Trim whitespace just in case
        repo=$(echo "$repo" | xargs)

        name=$(basename "$repo" .git)
        target="$CONSTRUCT_DIR/$name"
        echo "Syncing $name..."

        if [ -d "$target" ]; then
            (cd "$target" && git pull)
        else
            git clone "$repo" "$target"
        fi
    done

    echo -e "\033[0;32m[OK] Grid Synchronization Complete.\033[0m"
}

# 6. Burn Logic (Kill Switch)
burn_protocol() {
    echo -e "\033[0;31mðŸ”¥ WARNING: THE BURN PROTOCOL ðŸ”¥\033[0m"
    echo "This will IRREVERSIBLY DELETE:"
    echo "1. All Hubs in $CONSTRUCT_DIR"
    echo "2. The Hidden Core in $HOME/.sprawl"
    echo "3. The Sprawl CLI binary"
    echo ""
    read -p "Are you sure you want to burn the Grid? (y/N): " confirm
    if [[ "$confirm" != "y" ]]; then
        echo "Burn aborted."
        exit 0
    fi

    echo -e "\033[0;33m[..] Burning Hubs...\033[0m"
    rm -rf "$CONSTRUCT_DIR"

    echo -e "\033[0;33m[..] Unlinking CLI (Requires Sudo)...\033[0m"
    sudo rm -f "/usr/local/bin/sprawl"

    echo -e "\033[0;33m[..] Burning Core...\033[0m"
    # We do this last because this script lives here
    rm -rf "$HOME/.sprawl"

    echo -e "\033[0;32m[OK] The Grid has been wiped. No trace remains.\033[0m"
}

# 0. UI Components
# 0. UI Components
show_banner() {
    printf "\033[0;35m"
    printf "  _______ _               _____                         _ \n"
    printf " |__   __| |             / ____|                       | |\n"
    printf "    | |  | |__   ___    | (___  _ __  _ __ __ ___      _| |\n"
    printf "    | |  | '_ \ / _ \    \___ \| '_ \| '__/ _\` \ \ /\ / / |\n"
    printf "    | |  | | | |  __/    ____) | |_) | | | (_| |\ V  V /| |\n"
    printf "    |_|  |_| |_|\___|   |_____/| .__/|_|  \__,_| \_/\_/ |_|\n"
    printf "                               | |                         \n"
    printf "                               |_|                         \n"
    printf "\033[0m"
    printf "\033[0;36m:: SYSTEM ONLINE :: v$VERSION ::\033[0m\n\n"
}

show_help() {
    show_banner
    printf "Usage: \033[0;32msprawl\033[0m \033[0;33m[command]\033[0m\n\n"
    printf "Commands:\n"
    printf "  \033[0;32minit\033[0m \033[0;33m\"Name\"\033[0m   Initialize a new Hub in the current directory.\n"
    printf "                  (Scaffolds Rules, Skills, Workflows based on package.md)\n"
    printf "  \033[0;32msync\033[0m          Synchronize all Hubs from the Grid.\n"
    printf "                  (Updates Core, Pulls latest repos from Manifest)\n"
    printf "  \033[0;32mburn\033[0m          Uninstall The Sprawl.\n"
    printf "                  (Irreversibly deletes local Core and Hubs)\n\n"
    printf "Example:\n"
    printf "  sprawl init \"Marketing Hub\"\n\n"
}

# 7. Interface
case "$1" in
    init)
        show_banner
        scaffold_workspace "$2"
        ;;
    sync)
        show_banner
        sync_grid
        ;;
    burn)
        # burn has its own warning header
        burn_protocol
        ;;
    -v|--version)
        echo "The Sprawl v$VERSION"
        ;;
    -h|--help)
        show_help
        exit 0
        ;;
    *)
        show_help
        exit 0
        ;;
esac
